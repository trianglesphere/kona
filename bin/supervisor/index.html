<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kona Supervisor Data Flow Animation</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #ffffff;
        }
        
        h1 {
            text-align: center;
            background: linear-gradient(to right, #4CAF50, #2196F3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.5rem;
            margin-bottom: 30px;
        }
        
        #canvas {
            width: 100%;
            max-width: 1400px;
            height: 850px;
            margin: 0 auto;
            background: #0d0d0d;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
            border: 1px solid #333;
        }
        
        .group-box {
            position: absolute;
            border: 2px dashed #444;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.02);
            opacity: 0;
            transition: all 0.4s;
        }
        
        .group-box.active {
            opacity: 1;
            border-color: #666;
            background: rgba(33, 150, 243, 0.05);
        }
        
        .group-label {
            position: absolute;
            top: -12px;
            left: 20px;
            background: #0d0d0d;
            padding: 0 10px;
            color: #888;
            font-size: 14px;
            font-weight: 600;
        }
        
        .module {
            position: absolute;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            opacity: 0;
            transform: scale(0.8);
            font-size: 14px;
            text-align: center;
            border: 2px solid transparent;
            z-index: 10;
        }
        
        .module.active {
            opacity: 1;
            transform: scale(1);
            border-color: currentColor;
        }
        
        .module.active.pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 currentColor; }
            50% { box-shadow: 0 0 20px 10px transparent; }
            100% { box-shadow: 0 0 0 0 transparent; }
        }
        
        .global {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }
        
        .global.active {
            box-shadow: 0 0 30px rgba(76, 175, 80, 0.6);
        }
        
        .per-chain {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
        }
        
        .per-chain.active {
            box-shadow: 0 0 30px rgba(33, 150, 243, 0.6);
        }
        
        .channel {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
        }
        
        .channel.active {
            box-shadow: 0 0 30px rgba(255, 152, 0, 0.6);
        }
        
        .connection {
            position: absolute;
            stroke: #444;
            stroke-width: 2;
            fill: none;
            opacity: 0;
            transition: all 0.5s;
        }
        
        .connection.active {
            opacity: 1;
            stroke: #4CAF50;
            stroke-width: 3;
        }
        
        .data-flow {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: radial-gradient(circle, #FFD700 0%, #FFA500 100%);
            box-shadow: 0 0 20px #FFD700, 0 0 40px #FFD700;
            display: none;
            z-index: 1000;
        }
        
        .control-panel {
            text-align: center;
            margin: 30px 0;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.5);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button.active {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .description {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            color: white;
            border-radius: 10px;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid #333;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .description.show {
            opacity: 1;
        }
        
        .legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
            font-size: 14px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .arrow-marker {
            fill: #4CAF50;
        }
    </style>
</head>
<body>
    <h1>Kona Supervisor System - Interactive Data Flow</h1>
    
    <div class="control-panel">
        <button onclick="startAnimation()">Start Animation</button>
        <button onclick="showUnsafeEventFlow()">Unsafe Event</button>
        <button onclick="showDerivedBlockFlow()">Derived Block</button>
        <button onclick="showCrossUnsafeFlow()">Cross Unsafe</button>
        <button onclick="showCrossSafeFlow()">Cross Safe</button>
        <button onclick="showBlockInvalidationFlow()">Block Invalidation</button>
        <button onclick="showBlockReplacementFlow()">Block Replacement</button>
        <button onclick="showReorgFlow()">Reorg Flow</button>
        <button onclick="showFullSystem()">Full System</button>
        <button onclick="resetAnimation()">Reset</button>
    </div>
    
    <div id="canvas">
        <!-- SVG for connections -->
        <svg>
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                        refX="10" refY="3.5" orient="auto" class="arrow-marker">
                    <polygon points="0 0, 10 3.5, 0 7" />
                </marker>
            </defs>
            <!-- Connections will be drawn here -->
        </svg>
        
        <!-- Legend -->
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);"></div>
                <span>Global Module</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);"></div>
                <span>Per-Chain Module</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);"></div>
                <span>Channel</span>
            </div>
        </div>
        
        <!-- Per-Chain Modules Group Box -->
        <div class="group-box" id="per-chain-group" style="top: 320px; left: 150px; width: 950px; height: 350px;">
            <div class="group-label">Modules Per Chain</div>
        </div>
        
        <!-- Global Modules -->
        <div class="module global" id="svc" style="top: 50px; left: 550px;">Supervisor Service</div>
        <div class="module global" id="dbf" style="top: 150px; left: 200px;">ChainDbFactory</div>
        <div class="module global" id="l1w" style="top: 150px; left: 450px;">L1Watcher</div>
        <div class="module global" id="rh" style="top: 150px; left: 700px;">ReorgHandler</div>
        <div class="module global" id="srpc" style="top: 150px; left: 950px;">RPC Actor</div>
        <div class="module global" id="srpcs" style="top: 250px; left: 950px;">RPC Server</div>
        
        <!-- Per-Chain Modules -->
        <div class="module per-chain" id="mnode" style="top: 380px; left: 200px;">ManagedNode</div>
        <div class="module per-chain" id="mn" style="top: 480px; left: 200px;">ManagedNodeActor</div>
        <div class="module per-chain" id="cp" style="top: 380px; left: 450px;">ChainProcessor</div>
        <div class="module per-chain" id="cpa" style="top: 480px; left: 450px;">ChainProcessorActor</div>
        <div class="module per-chain" id="cscj_safe" style="top: 380px; left: 700px;">CrossSafetyChecker<br>(Safe)</div>
        <div class="module per-chain" id="cscj_unsafe" style="top: 380px; left: 900px;">CrossSafetyChecker<br>(Unsafe)</div>
        
        <!-- Channels (inside per-chain group) -->
        <div class="module channel" id="chan" style="top: 580px; left: 350px;">ChainEvent Channel</div>
        <div class="module channel" id="cmdchan" style="top: 580px; left: 700px;">Command Channel</div>
        
        <!-- Data flow dots -->
        <div class="data-flow" id="flow1"></div>
        <div class="data-flow" id="flow2"></div>
        <div class="data-flow" id="flow3"></div>
        <div class="data-flow" id="flow4"></div>
        <div class="data-flow" id="flow5"></div>
        <div class="data-flow" id="flow6"></div>
        
        <!-- Description panel -->
        <div class="description" id="description"></div>
    </div>
    
    <script>
        let animationStep = 0;
        let animationInterval;
        let activeConnections = [];
        
        const modules = document.querySelectorAll('.module');
        const description = document.getElementById('description');
        const svg = document.querySelector('svg');
        const perChainGroup = document.getElementById('per-chain-group');
        
        const animations = [
            {
                modules: ['svc'],
                connections: [],
                showPerChainGroup: false,
                description: 'üöÄ Supervisor Service initializes and orchestrates all subsystems'
            },
            {
                modules: ['svc', 'dbf', 'l1w', 'srpc'],
                connections: [['svc', 'dbf'], ['svc', 'l1w'], ['svc', 'srpc']],
                showPerChainGroup: false,
                description: 'üîß Supervisor Service creates core components: ChainDbFactory for storage, L1Watcher for blockchain monitoring, and RPC Actor for external communication'
            },
            {
                modules: ['l1w', 'rh'],
                connections: [['l1w', 'rh']],
                showPerChainGroup: false,
                description: 'üîó L1Watcher monitors Layer 1 blockchain and connects to ReorgHandler for chain reorganization management'
            },
            {
                modules: ['srpc', 'srpcs'],
                connections: [['srpc', 'srpcs']],
                showPerChainGroup: false,
                description: 'üì° RPC Actor creates RPC Server for external API communication'
            },
            {
                modules: ['svc', 'mnode', 'mn', 'cp', 'cpa', 'cscj_safe', 'cscj_unsafe', 'chan', 'cmdchan'],
                connections: [['svc', 'per-chain-group'], ['cp', 'mnode'], ['mn', 'mnode'], ['cpa', 'cp']],
                showPerChainGroup: true,
                description: '‚õìÔ∏è Supervisor initializes Per-Chain Modules: ManagedNode handles node operations, ChainProcessor manages chain state, CrossSafetyCheckers verify consistency, and channels enable communication'
            },
            {
                modules: ['cscj_safe', 'cscj_unsafe', 'dbf'],
                connections: [['cscj_safe', 'dbf'], ['cscj_unsafe', 'dbf']],
                showPerChainGroup: true,
                description: 'üîí CrossSafetyChecker jobs connect to ChainDbFactory to verify cross-chain safety for both safe and unsafe block promotions'
            }
        ];
        
        function drawConnection(fromId, toId, isActive = false) {
            const from = fromId === 'per-chain-group' ? perChainGroup : document.getElementById(fromId);
            const to = toId === 'per-chain-group' ? perChainGroup : document.getElementById(toId);
            if (!from || !to) return null;
            
            const fromRect = from.getBoundingClientRect();
            const toRect = to.getBoundingClientRect();
            const canvasRect = document.getElementById('canvas').getBoundingClientRect();
            
            let startX, startY, endX, endY;
            
            if (fromId === 'svc' && toId === 'per-chain-group') {
                startX = fromRect.left + fromRect.width / 2 - canvasRect.left;
                startY = fromRect.bottom - canvasRect.top;
                endX = toRect.left + toRect.width / 2 - canvasRect.left;
                endY = toRect.top - canvasRect.top;
            } else {
                startX = fromRect.left + fromRect.width / 2 - canvasRect.left;
                startY = fromRect.top + fromRect.height / 2 - canvasRect.top;
                endX = toRect.left + toRect.width / 2 - canvasRect.left;
                endY = toRect.top + toRect.height / 2 - canvasRect.top;
            }
            
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const d = `M ${startX} ${startY} L ${endX} ${endY}`;
            path.setAttribute('d', d);
            path.setAttribute('class', `connection ${isActive ? 'active' : ''}`);
            path.setAttribute('marker-end', 'url(#arrowhead)');
            path.setAttribute('id', `conn-${fromId}-${toId}`);
            
            return path;
        }
        
        function clearConnections() {
            svg.querySelectorAll('.connection').forEach(conn => conn.remove());
            activeConnections = [];
        }
        
        function resetAnimation() {
            clearInterval(animationInterval);
            animationStep = 0;
            modules.forEach(m => m.classList.remove('active', 'pulse'));
            perChainGroup.classList.remove('active');
            description.classList.remove('show');
            document.querySelectorAll('.data-flow').forEach(d => d.style.display = 'none');
            clearConnections();
        }
        
        function startAnimation() {
            resetAnimation();
            
            animationInterval = setInterval(() => {
                if (animationStep < animations.length) {
                    // Clear previous highlights
                    modules.forEach(m => m.classList.remove('active', 'pulse'));
                    perChainGroup.classList.remove('active');
                    clearConnections();
                    
                    const currentAnimation = animations[animationStep];
                    
                    // Show per-chain group if needed
                    if (currentAnimation.showPerChainGroup) {
                        perChainGroup.classList.add('active');
                    }
                    
                    // Highlight current modules
                    currentAnimation.modules.forEach(moduleId => {
                        const module = document.getElementById(moduleId);
                        if (module) {
                            module.classList.add('active');
                            if (animationStep === 0) module.classList.add('pulse');
                        }
                    });
                    
                    // Draw connections
                    currentAnimation.connections.forEach(([from, to]) => {
                        const conn = drawConnection(from, to, true);
                        if (conn) {
                            svg.appendChild(conn);
                            activeConnections.push(conn);
                        }
                    });
                    
                    // Update description
                    description.innerHTML = currentAnimation.description;
                    description.classList.add('show');
                    
                    animationStep++;
                } else {
                    clearInterval(animationInterval);
                    setTimeout(() => showUnsafeEventFlow(), 1000);
                }
            }, 2500);
        }
        
        function animateDataFlow(fromId, toId, flowId, callback) {
            const from = document.getElementById(fromId);
            const to = document.getElementById(toId);
            const flow = document.getElementById(flowId);
            
            if (!from || !to || !flow) return;
            
            const fromRect = from.getBoundingClientRect();
            const toRect = to.getBoundingClientRect();
            const canvasRect = document.getElementById('canvas').getBoundingClientRect();
            
            const startX = fromRect.left + fromRect.width / 2 - canvasRect.left;
            const startY = fromRect.top + fromRect.height / 2 - canvasRect.top;
            const endX = toRect.left + toRect.width / 2 - canvasRect.left;
            const endY = toRect.top + toRect.height / 2 - canvasRect.top;
            
            flow.style.display = 'block';
            flow.style.left = startX + 'px';
            flow.style.top = startY + 'px';
            
            let progress = 0;
            const animation = setInterval(() => {
                progress += 0.025;
                if (progress >= 1) {
                    clearInterval(animation);
                    flow.style.display = 'none';
                    if (callback) callback();
                    return;
                }
                
                const x = startX + (endX - startX) * progress;
                const y = startY + (endY - startY) * progress;
                flow.style.left = x + 'px';
                flow.style.top = y + 'px';
            }, 20);
        }
        
        function showUnsafeEventFlow() {
            resetAnimation();
            description.innerHTML = '‚ö†Ô∏è <strong>Unsafe Event Flow:</strong> ManagedNodeActor receives unsafe block ‚Üí ManagedNode processes it ‚Üí sends event through ChainEvent Channel ‚Üí ChainProcessorActor receives ‚Üí ChainProcessor processes ‚Üí stores in ChainDbFactory';
            description.classList.add('show');
            perChainGroup.classList.add('active');
            
            ['mn', 'mnode', 'chan', 'cpa', 'cp', 'dbf'].forEach(id => {
                const module = document.getElementById(id);
                if (module) module.classList.add('active');
            });
            
            const connections = [
                ['mn', 'mnode'],
                ['mnode', 'chan'],
                ['chan', 'cpa'],
                ['cpa', 'cp'],
                ['cp', 'dbf']
            ];
            
            connections.forEach(([from, to]) => {
                const conn = drawConnection(from, to, true);
                if (conn) svg.appendChild(conn);
            });
            
            // Animate flow
            setTimeout(() => animateDataFlow('mn', 'mnode', 'flow1'), 500);
            setTimeout(() => animateDataFlow('mnode', 'chan', 'flow2'), 1000);
            setTimeout(() => animateDataFlow('chan', 'cpa', 'flow3'), 1500);
            setTimeout(() => animateDataFlow('cpa', 'cp', 'flow4'), 2000);
            setTimeout(() => animateDataFlow('cp', 'dbf', 'flow5'), 2500);
        }
        
        function showDerivedBlockFlow() {
            resetAnimation();
            description.innerHTML = 'üì¶ <strong>Derived Block Event Flow:</strong> ManagedNodeActor receives derived block ‚Üí ManagedNode processes it ‚Üí sends event through ChainEvent Channel ‚Üí ChainProcessorActor receives ‚Üí ChainProcessor processes ‚Üí stores in ChainDbFactory';
            description.classList.add('show');
            perChainGroup.classList.add('active');
            
            ['mn', 'mnode', 'chan', 'cpa', 'cp', 'dbf'].forEach(id => {
                const module = document.getElementById(id);
                if (module) module.classList.add('active');
            });
            
            const connections = [
                ['mn', 'mnode'],
                ['mnode', 'chan'],
                ['chan', 'cpa'],
                ['cpa', 'cp'],
                ['cp', 'dbf']
            ];
            
            connections.forEach(([from, to]) => {
                const conn = drawConnection(from, to, true);
                if (conn) svg.appendChild(conn);
            });
            
            // Animate flow
            setTimeout(() => animateDataFlow('mn', 'mnode', 'flow1'), 500);
            setTimeout(() => animateDataFlow('mnode', 'chan', 'flow2'), 1000);
            setTimeout(() => animateDataFlow('chan', 'cpa', 'flow3'), 1500);
            setTimeout(() => animateDataFlow('cpa', 'cp', 'flow4'), 2000);
            setTimeout(() => animateDataFlow('cp', 'dbf', 'flow5'), 2500);
        }
        
        function showCrossUnsafeFlow() {
            resetAnimation();
            description.innerHTML = 'üîÑ <strong>Cross Unsafe Block Promotion Flow:</strong> CrossSafetyChecker (Unsafe) detects promotable block ‚Üí sends event through ChainEvent Channel ‚Üí ChainProcessorActor ‚Üí ChainProcessor creates command ‚Üí Command Channel ‚Üí ManagedNodeActor ‚Üí ManagedNode promotes block';
            description.classList.add('show');
            perChainGroup.classList.add('active');
            
            ['cscj_unsafe', 'chan', 'cpa', 'cp', 'cmdchan', 'mn', 'mnode'].forEach(id => {
                const module = document.getElementById(id);
                if (module) {
                    module.classList.add('active');
                    if (id === 'cscj_unsafe') module.classList.add('pulse');
                }
            });
            
            const connections = [
                ['cscj_unsafe', 'chan'],
                ['chan', 'cpa'],
                ['cpa', 'cp'],
                ['cp', 'cmdchan'],
                ['cmdchan', 'mn'],
                ['mn', 'mnode']
            ];
            
            connections.forEach(([from, to]) => {
                const conn = drawConnection(from, to, true);
                if (conn) svg.appendChild(conn);
            });
            
            // Animate flow
            setTimeout(() => animateDataFlow('cscj_unsafe', 'chan', 'flow1'), 500);
            setTimeout(() => animateDataFlow('chan', 'cpa', 'flow2'), 1100);
            setTimeout(() => animateDataFlow('cpa', 'cp', 'flow3'), 1700);
            setTimeout(() => animateDataFlow('cp', 'cmdchan', 'flow4'), 2300);
            setTimeout(() => animateDataFlow('cmdchan', 'mn', 'flow5'), 2900);
            setTimeout(() => animateDataFlow('mn', 'mnode', 'flow6'), 3500);
        }
        
        function showCrossSafeFlow() {
            resetAnimation();
            description.innerHTML = '‚úÖ <strong>Cross Safe Block Promotion Flow:</strong> CrossSafetyChecker (Safe) detects finalized block ‚Üí sends event through ChainEvent Channel ‚Üí ChainProcessorActor ‚Üí ChainProcessor creates command ‚Üí Command Channel ‚Üí ManagedNodeActor ‚Üí ManagedNode finalizes block';
            description.classList.add('show');
            perChainGroup.classList.add('active');
            
            ['cscj_safe', 'chan', 'cpa', 'cp', 'cmdchan', 'mn', 'mnode'].forEach(id => {
                const module = document.getElementById(id);
                if (module) {
                    module.classList.add('active');
                    if (id === 'cscj_safe') module.classList.add('pulse');
                }
            });
            
            const connections = [
                ['cscj_safe', 'chan'],
                ['chan', 'cpa'],
                ['cpa', 'cp'],
                ['cp', 'cmdchan'],
                ['cmdchan', 'mn'],
                ['mn', 'mnode']
            ];
            
            connections.forEach(([from, to]) => {
                const conn = drawConnection(from, to, true);
                if (conn) svg.appendChild(conn);
            });
            
            // Animate flow
            setTimeout(() => animateDataFlow('cscj_safe', 'chan', 'flow1'), 500);
            setTimeout(() => animateDataFlow('chan', 'cpa', 'flow2'), 1100);
            setTimeout(() => animateDataFlow('cpa', 'cp', 'flow3'), 1700);
            setTimeout(() => animateDataFlow('cp', 'cmdchan', 'flow4'), 2300);
            setTimeout(() => animateDataFlow('cmdchan', 'mn', 'flow5'), 2900);
            setTimeout(() => animateDataFlow('mn', 'mnode', 'flow6'), 3500);
        }
        
        function showBlockInvalidationFlow() {
            resetAnimation();
            description.innerHTML = '‚ùå <strong>Block Invalidation Flow:</strong> CrossSafetyChecker (Safe) detects invalid block ‚Üí sends invalidation event through ChainEvent Channel ‚Üí ChainProcessorActor ‚Üí ChainProcessor creates invalidate command ‚Üí Command Channel ‚Üí ManagedNodeActor ‚Üí ManagedNode removes invalid block';
            description.classList.add('show');
            perChainGroup.classList.add('active');
            
            ['cscj_safe', 'chan', 'cpa', 'cp', 'cmdchan', 'mn', 'mnode'].forEach(id => {
                const module = document.getElementById(id);
                if (module) {
                    module.classList.add('active');
                    if (id === 'cscj_safe') module.classList.add('pulse');
                }
            });
            
            const connections = [
                ['cscj_safe', 'chan'],
                ['chan', 'cpa'],
                ['cpa', 'cp'],
                ['cp', 'cmdchan'],
                ['cmdchan', 'mn'],
                ['mn', 'mnode']
            ];
            
            connections.forEach(([from, to]) => {
                const conn = drawConnection(from, to, true);
                if (conn) svg.appendChild(conn);
            });
            
            // Animate flow
            setTimeout(() => animateDataFlow('cscj_safe', 'chan', 'flow1'), 500);
            setTimeout(() => animateDataFlow('chan', 'cpa', 'flow2'), 1100);
            setTimeout(() => animateDataFlow('cpa', 'cp', 'flow3'), 1700);
            setTimeout(() => animateDataFlow('cp', 'cmdchan', 'flow4'), 2300);
            setTimeout(() => animateDataFlow('cmdchan', 'mn', 'flow5'), 2900);
            setTimeout(() => animateDataFlow('mn', 'mnode', 'flow6'), 3500);
        }
        
        function showBlockReplacementFlow() {
            resetAnimation();
            description.innerHTML = 'üîÅ <strong>Block Replacement Flow:</strong> ManagedNodeActor detects block replacement ‚Üí ManagedNode processes replacement ‚Üí sends event through ChainEvent Channel ‚Üí ChainProcessorActor ‚Üí ChainProcessor updates state ‚Üí stores replacement in ChainDbFactory';
            description.classList.add('show');
            perChainGroup.classList.add('active');
            
            ['mn', 'mnode', 'chan', 'cpa', 'cp', 'dbf'].forEach(id => {
                const module = document.getElementById(id);
                if (module) {
                    module.classList.add('active');
                    if (id === 'mn' || id === 'mnode') module.classList.add('pulse');
                }
            });
            
            const connections = [
                ['mn', 'mnode'],
                ['mnode', 'chan'],
                ['chan', 'cpa'],
                ['cpa', 'cp'],
                ['cp', 'dbf']
            ];
            
            connections.forEach(([from, to]) => {
                const conn = drawConnection(from, to, true);
                if (conn) svg.appendChild(conn);
            });
            
            // Animate flow
            setTimeout(() => animateDataFlow('mn', 'mnode', 'flow1'), 500);
            setTimeout(() => animateDataFlow('mnode', 'chan', 'flow2'), 1000);
            setTimeout(() => animateDataFlow('chan', 'cpa', 'flow3'), 1500);
            setTimeout(() => animateDataFlow('cpa', 'cp', 'flow4'), 2000);
            setTimeout(() => animateDataFlow('cp', 'dbf', 'flow5'), 2500);
        }
        
        function showReorgFlow() {
            resetAnimation();
            description.innerHTML = 'üîÑ <strong>Reorg Flow:</strong> L1Watcher detects blockchain reorganization ‚Üí triggers ReorgHandler ‚Üí sends reset commands through Command Channel ‚Üí ManagedNodeActor ‚Üí resets ManagedNode';
            description.classList.add('show');
            perChainGroup.classList.add('active');
            
            ['l1w', 'rh', 'cmdchan', 'mn', 'mnode'].forEach(id => {
                const module = document.getElementById(id);
                if (module) {
                    module.classList.add('active');
                    if (id === 'l1w' || id === 'rh') module.classList.add('pulse');
                }
            });
            
            // Draw connections
            const reorgConnections = [
                ['l1w', 'rh'],
                ['rh', 'cmdchan'],
                ['cmdchan', 'mn'],
                ['mn', 'mnode']
            ];
            
            reorgConnections.forEach(([from, to]) => {
                const conn = drawConnection(from, to, true);
                if (conn) svg.appendChild(conn);
            });
            
            // Animate reorg flow with emphasis
            setTimeout(() => animateDataFlow('l1w', 'rh', 'flow1'), 500);
            setTimeout(() => animateDataFlow('rh', 'cmdchan', 'flow2'), 1200);
            setTimeout(() => animateDataFlow('cmdchan', 'mn', 'flow3'), 1900);
            setTimeout(() => animateDataFlow('mn', 'mnode', 'flow4'), 2600);
        }
        
        function showFullSystem() {
            resetAnimation();
            description.innerHTML = 'üåê <strong>Full System View:</strong> Complete Kona Supervisor architecture with all modules and connections. The "Modules Per Chain" group contains chain-specific components and communication channels.';
            description.classList.add('show');
            perChainGroup.classList.add('active');
            
            // Activate all modules
            modules.forEach(m => m.classList.add('active'));
            
            // Draw all connections
            const allConnections = [
                // Global connections
                ['svc', 'dbf'],
                ['svc', 'l1w'],
                ['svc', 'srpc'],
                ['svc', 'per-chain-group'],
                ['l1w', 'rh'],
                ['srpc', 'srpcs'],
                ['srpcs', 'dbf'],
                // Per-chain connections
                ['cpa', 'cp'],
                ['cp', 'mnode'],
                ['cp', 'dbf'],
                ['mn', 'mnode'],
                ['cscj_safe', 'dbf'],
                ['cscj_unsafe', 'dbf'],
                // Event flow
                ['mnode', 'chan'],
                ['l1w', 'chan'],
                ['cscj_safe', 'chan'],
                ['cscj_unsafe', 'chan'],
                ['chan', 'cpa'],
                // Command flow
                ['cp', 'cmdchan'],
                ['rh', 'cmdchan'],
                ['cmdchan', 'mn']
            ];
            
            allConnections.forEach(([from, to]) => {
                const conn = drawConnection(from, to, true);
                if (conn) svg.appendChild(conn);
            });
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (activeConnections.length > 0) {
                const currentActive = modules[0].classList.contains('active');
                if (currentActive) {
                    clearConnections();
                    // Redraw connections based on current state
                }
            }
        });
        
        // Start with initial animation
        setTimeout(startAnimation, 1000);
    </script>
</body>
</html>